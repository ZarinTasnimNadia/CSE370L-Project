<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - GottaTradeEmAll</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='emolgaIcon.png') }}">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Google Fonts for Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background: linear-gradient(to bottom,
        rgba(0, 0, 0, 0.1) 0%,
        rgba(0, 0, 0, 0.1) 75%,
        rgba(74, 20, 140, 0.1) 100%),
      url("{{ url_for('static', filename='backgroundImageLogin.jpg') }}");
      background-size: 100% 100%;
      background-repeat: repeat;
      background-attachment: fixed;
      background-blend-mode: overlay;
      min-height: 100vh;
      font-family: "Courier New", monospace;
      color: #f4f3f4ec;
    }

    .card {
      background: rgba(22, 23, 26, 0.6);
      border: 1px solid rgba(112, 116, 117, 0.7);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(24, 24, 33, 0.4);
      color: #e0f7fa;
      margin-bottom: 20px;
    }

    .card-msg {
      margin-bottom: 8px;
    }

    .card-title,
    .form-label,
    a {
      color: #e0f7fa !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #bd1a1a, #6e0e0e);
      border: none;
      color: #fff !important;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(135, 46, 14, 0.6);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #4bbd55, #0f8731);
      box-shadow: 0 3px 10px rgba(30, 229, 60, 0.8);
    }

    a:hover {
      color: #bbdefb !important;
    }

    .title-container {
      text-align: center;
      margin-bottom: 30px;
    }

    .title {
      font-family: "Roboto", sans-serif;
      font-weight: 900;
      font-size: 70px;
      color: #ffd600;
      letter-spacing: 2.5px;
      text-shadow: 0 3px 10px #000000b0, 0 6px 18px #00000080,
        2px 2px 0 #fffde7, 0 0 12px #ffd60080, 0 0 16px #00000040,
        0 0 24px #42a5f5cc;
      border-radius: 12px;
      padding: 8px 0;
      display: inline-block;
      transform: perspective(400px) rotateX(18deg);
    }

    .dashboard-header {
      background: rgba(109, 24, 24, 0.7);
      padding: 15px 0;
      margin-bottom: 25px;
      border-bottom: 2px solid rgba(230, 173, 173, 0.5);
    }

    .stat-card {
      text-align: center;
      padding: 15px;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffd600;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #bbdefb;
    }

    .trade-item,
    .auction-item,
    .battle-item {
      background: rgba(148, 36, 36, 0.4);
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 3px solid #a21550;
    }

    .battle-win {
      border-left: 3px solid #4caf50;
      /* Green for wins */
    }

    .battle-loss {
      border-left: 3px solid #f44336;
      /* Red for losses */
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4d4d;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-dropdown {
      background: rgba(22, 23, 26, 0.95);
      border: 1px solid rgba(112, 116, 117, 0.7);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(24, 24, 33, 0.6);
      width: 450px;
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .notification-dropdown .dropdown-header {
      background: rgba(109, 24, 24, 0.7);
      color: #e0f7fa;
      border-bottom: 1px solid rgba(230, 173, 173, 0.5);
      padding: 10px 15px;
    }

    .notification-item {
      color: #e0f7fa !important;
      padding: 12px 15px;
      border-bottom: 1px solid rgba(112, 116, 117, 0.3);
      transition: background-color 0.3s ease;
    }

    .notification-item:hover {
      background: rgba(148, 36, 36, 0.4);
      color: #bbdefb !important;
    }

    .notification-item.unread {
      background: rgba(74, 20, 140, 0.2);
      border-left: 3px solid #ffd600;
    }

    .notification-icon {
      width: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
      overflow-wrap: break-word;
    }

    .notification-title {
      font-weight: bold;
      font-size: 0.9rem;
      color: #ffd600;
      margin-bottom: 2px;
    }

    .notification-text {
      font-size: 0.8rem;
      color: #bbdefb;
      margin-bottom: 3px;
      word-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      line-height: 1.3;
    }

    .notification-time {
      font-size: 0.7rem;
      color: #9e9e9e;
    }

    .dropdown-divider {
      border-color: rgba(112, 116, 117, 0.3);
    }
  </style>
</head>

<body>
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2 class="mb-0">Trainer Dashboard</h2>
          <small>Hello, {{ user.name }}!</small>
        </div>
        <div class="col-md-6 text-end">
          <div class="btn-group">
            <button class="btn btn-outline-light btn-sm">
              <i class="fas fa-coins me-1" style="color: #ffd600"></i>
              Balance: ${{ user.balance }}
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-light btn-sm position-relative" type="button" id="notificationDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">{{ unread_count }}</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
                <div class="dropdown-header">
                  <strong>Notifications</strong>
                  <small class="text-muted">({{ unread_count }} unread)</small>
                </div>
                <div class="dropdown-divider"></div>
                {% for notification in notifications %}
                <a class="dropdown-item notification-item {% if not notification.is_read %}unread{% endif %}" href="#"
                  data-notification-id="{{ notification.notification_id }}">
                  <div class="d-flex">
                    <div class="notification-icon me-2">
                      {% if notification.type == 'wishlist_trade' %}
                      <i class="fas fa-exchange-alt text-info"></i>
                      {% elif notification.type == 'wishlist_auction' %}
                      <i class="fas fa-gavel text-warning"></i>
                      {% elif notification.type == 'trade_offer' %}
                      <i class="fas fa-handshake text-success"></i>
                      {% elif notification.type == 'auction_won' %}
                      <i class="fas fa-trophy text-success"></i>
                      {% else %}
                      <i class="fas fa-bell text-secondary"></i>
                      {% endif %}
                    </div>
                    <div class="notification-content">
                      <div class="notification-title">
                        {{ notification.title }}
                      </div>
                      <div class="notification-text">
                        {{ notification.message }}
                      </div>
                      <div class="notification-time">
                        {{ notification.created_at.strftime('%m/%d %H:%M') }}
                      </div>
                    </div>
                  </div>
                </a>
                {% else %}
                <div class="dropdown-item text-center text-muted">
                  <small>No notifications yet</small>
                </div>
                {% endfor %}
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-center text-muted" href="#">
                  <small>View All Notifications</small>
                </a>
              </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Stats Overview -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number">{{ cards }}</div>
          <div class="stat-label">Cards Owned</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number">{{ trades }}</div>
          <div class="stat-label">Active Trades</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number">{{ live_auctions }}</div>
          <div class="stat-label">Live Auctions</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number">{{ battles_count }}</div>
          <div class="stat-label">Battles Participated</div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="row">
      <!-- Left Column -->
      <div class="col-md-8">
        <!-- Active Trades -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-exchange-alt me-2"></i>Active Trades
            </h5>
            {% if dashboard_trades %} {% for trade in dashboard_trades %}
            <div class="trade-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>Trade #{{ trade.trade_id }}</strong> - {{
                  trade.trader_name }}'s {{ trade.card_name }}
                </div>
                <span class="badge bg-warning">Available</span>
              </div>
              <small>{{ trade.description }} | {% if trade.best_offer %}Best
                Offer: {{ trade.best_offer }}{% else %}No offers yet{% endif
                %}</small>
            </div>
            {% endfor %} {% else %}
            <div class="text-center py-3">
              <p class="text-muted">No active trades available.</p>
              <small>Check back later for new trades!</small>
            </div>
            {% endif %}
            <div class="text-end mt-3">
              <a href="{{ url_for('auctions') }}#trades" class="btn btn-primary btn-sm">View All Trades</a>
            </div>
          </div>
        </div>

        <!-- Live Auctions -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-gavel me-2"></i>Live Auctions
            </h5>
            {% if dashboard_auctions %} {% for auction in dashboard_auctions
            %}
            <div class="auction-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>{{ auction.card_name }}</strong> - Current bid: ${{
                  auction.current_bid or auction.starting_bid }}
                </div>
                <span class="badge bg-info">Ending Soon</span>
              </div>
              <small>
                {% if auction.user_bid_count > 0 %} You have {{
                auction.user_bid_count }} bid(s) on this auction {% else %}
                Starting bid: ${{ auction.starting_bid }} {% endif %}
              </small>
            </div>
            {% endfor %} {% else %}
            <div class="text-center py-3">
              <p class="text-muted">No live auctions available.</p>
              <small>Check back later for new auctions!</small>
            </div>
            {% endif %}
            <div class="text-end mt-3">
              <a href="{{ url_for('auctions') }}#auctions" class="btn btn-primary btn-sm">Browse Auctions</a>
            </div>
          </div>
        </div>

        <!--  INSERT NEW STUFF AFTER THIS-->

        <!-- Battle Histories -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-trophy me-2"></i>Battle Histories
            </h5>
            {% for battle in battles %}
            <div class="battle-item {% if battle.result == 'Win' %}battle-win{% else %}battle-loss{% endif %}">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>Vs. {{ battle.opponent }}</strong> - Winner: {% if
                  battle.result == 'Win' %}You{% else %}{{ battle.opponent
                  }}{% endif %}
                </div>
                <span class="badge {% if battle.result == 'Win' %}bg-success{% else %}bg-danger{% endif %}">
                  {{ battle.result }}
                </span>
              </div>
              <small>
                {% if battle.prize %}Prize: ${{ battle.prize }}{% elif
                battle.stake %}Stake: ${{ battle.stake }}{% endif %} | {{
                battle.date.strftime('%b %d, %Y') }}
              </small>
            </div>
            {% endfor %}

            <div class="text-end mt-3">
              <form action="{{ url_for('battle_history') }}" method="get" class="text-end">
                <button type="submit" class="btn btn-primary btn-sm">
                  View All Battles
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-bolt me-2"></i>Quick Actions
            </h5>
            <div class="d-grid gap-2">
              <a href="{{ url_for('my_cards') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Card to Inventory
              </a>
              <a href="{{ url_for('wishlist') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add a Card to Your Wishlist
              </a>
              <a href="{{ url_for('market') }}#trades" class="btn btn-primary">
                <i class="fas fa-exchange-alt me-2"></i>Start New Trade
              </a>
              <a href="{{ url_for('market') }}#auctions" class="btn btn-primary">
                <i class="fas fa-gavel me-2"></i>Create Auction
              </a>
              <a href="{{ url_for('battle_history') }}" class="btn btn-primary">
                <i class="fas fa-fist-raised me-2"></i>Start Battle
              </a>
              <a href="{{ url_for('my_cards') }}" class="btn btn-primary">
                <i class="fas fa-clone me-2"></i>My Cards List
              </a>
            </div>
          </div>
        </div>
        <!-- CHAT Stuffs Kichu ekta -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-envelope me-2"></i>Chat Box
            </h5>
            <div class="d-grid gap-2">
              {% for u in allusers %}
              <form action="{{ url_for('chatbox') }}" method="get" class="mb-2">
                <input type="hidden" name="recipient_id" value="{{ u.user_id }}" />
                <button type="submit" class="btn btn-primary w-100 text-start p-2">
                  <div class="card-msg mb-0">
                    <i class="fas fa-user me-2"></i> {{ u.name }}
                  </div>
                </button>
              </form>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Handle notification clicks
      document
        .querySelectorAll(".notification-item")
        .forEach(function (item) {
          item.addEventListener("click", function (e) {
            e.preventDefault();
            const notificationId = this.getAttribute("data-notification-id");
            if (notificationId && this.classList.contains("unread")) {
              markNotificationRead(notificationId, this);
            }
          });
        });
    });

    function markNotificationRead(notificationId, element) {
      fetch(`/mark_notification_read/${notificationId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Update UI to mark notification as read
            element.classList.remove("unread");

            // Update unread count
            const badge = document.querySelector(".notification-badge");
            const currentCount = parseInt(badge.textContent);
            if (currentCount > 0) {
              badge.textContent = currentCount - 1;
            }
          }
        })
        .catch((error) => {
          console.error("Error marking notification as read:", error);
        });
    }
  </script>
</body>

</html>